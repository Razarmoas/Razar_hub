-- HUB SETUP
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local player = game.Players.LocalPlayer

local ts = game:GetService("TeleportService")

local Window = Rayfield:CreateWindow({
	Name = "Razar Hub",
	Icon = 0,
	LoadingTitle = "Razarhub",
	LoadingSubtitle = "by Razarmous",
	ShowText = "EB",
	Theme = "Default",
	ToggleUIKeybind = "M",
	DisableRayfieldPrompts = false,
	DisableBuildWarnings = false,
	ConfigurationSaving = { Enabled = true, FolderName = nil, FileName = "Razar_hub" },
	Discord = { Enabled = true, Invite = "https://discord.gg/jy8MaBt6", RememberJoins = true },
	KeySystem = true,
	KeySettings = {
		Title = "Razar Hub",
		Subtitle = "Enter Key",
		Note = "Join the discord server for key",
		FileName = "Razar_Hub",
		SaveKey = true,
		GrabKeyFromSite = false,
		Key = { "X21KUK12X" }
	}
})

local p = game.Players.LocalPlayer
local rs = game:GetService("RunService")
local ts = game:GetService("TweenService")
local uis = game:GetService("UserInputService")


local HomeTab = Window:CreateTab("HOME", nil)
	local HomeSection = HomeTab:CreateSection("Home")

	local cube, ir, or1, or2, sphere = {}, {}, {}, {}, {}
	local spin, mode, trail = false, nil, false
	local tparts, tdata, ttime, tint, tspc, lastp = {}, {}, 0, 0.1, 5, nil

	local ti = TweenInfo.new(0.1, Enum.EasingStyle.Linear)
	local rot, ang, irs, ors, ors2, ira, ora, ora2 = Vector3.new(math.random(), math.random(), math.random()), Vector3.new(), Vector3.new(), Vector3.new(), Vector3.new(), Vector3.new(), Vector3.new(), Vector3.new()
	local srot, sang = Vector3.new(math.random(), math.random(), math.random()), Vector3.new()

	-- FUNCTIONS TO CREATE PARTS
	local function mp()
		local o = Instance.new("Part")
		o.Size = Vector3.new(2,2,2)
		o.Anchored = true
		o.CanCollide = false
		o.Color = Color3.fromRGB(255,23,27)
		o.Material = Enum.Material.SmoothPlastic
		o.Position = p.Character.HumanoidRootPart.Position
		o.Parent = workspace
		return o
	end

	local function rc()
		local all = {}
		for _, tbl in ipairs({cube, ir, or1, or2, sphere}) do
			for _, x in ipairs(tbl) do
				table.insert(all, x.part)
			end
		end
		local c = p.Character and p.Character:FindFirstChild("HumanoidRootPart")
		for _, pr in ipairs(all) do
			if c then
				ts:Create(pr, TweenInfo.new(0.5), {CFrame = CFrame.new(c.Position), Size = Vector3.new(0.1,0.1,0.1)}):Play()
			end
		end
		task.delay(0.5, function()
			for _, pr in ipairs(all) do if pr and pr.Parent then pr:Destroy() end end
		end)
		cube, ir, or1, or2, sphere, spin, mode = {}, {}, {}, {}, {}, false, nil
	end

	local function rr() return Vector3.new(math.random()*2-1, math.random()*2-1, math.random()*2-1) end
	local function ap(r) for _, x in ipairs(r) do x.rs = rr(); x.ra = Vector3.new() end end

	-- CREATE SHAPES
	local function makeCube()
		if mode == "cube" then rc() return end
		rc()
		mode = "cube"
		local s, ps, sp = 3, 2, 0.5
		local tot = s*ps + (s-1)*sp
		local h = tot/2
		for x=0,s-1 do
			for y=0,s-1 do
				for z=0,s-1 do
					local pa = mp()
					local off = Vector3.new(x*(ps+sp)-h+ps/2, y*(ps+sp)-h+ps/2, z*(ps+sp)-h+ps/2)
					table.insert(cube, {part=pa, offset=off})
				end
			end
		end
		spin = true
	end

	local function makeRing()
		if mode == "ring" then rc() return end
		rc()
		mode = "ring"
		local inf = {{r={}, c=10, rad=5},{r={}, c=15, rad=8},{r={}, c=20, rad=11}}
		for _, i in ipairs(inf) do
			for k=1,i.c do
				local pa = mp()
				local a = (k/i.c)*math.pi*2
				table.insert(i.r, {part=pa, angle=a, radius=i.rad})
			end
			ap(i.r)
		end
		ir, or1, or2 = inf[1].r, inf[2].r, inf[3].r
		irs, ors, ors2 = rr(), rr(), rr()
		spin = true
	end

	local function makeSphere()
		if mode == "sphere" then rc() return end
		rc()
		mode = "sphere"
		local cnt = 100
		for i=1,cnt do
			local pa = mp()
			local theta = math.acos(2*math.random()-1)
			local phi = 2*math.pi*math.random()
			local r = 8
			local x = r*math.sin(theta)*math.cos(phi)
			local y = r*math.cos(theta)
			local z = r*math.sin(theta)*math.sin(phi)
			table.insert(sphere, {part=pa, offset=Vector3.new(x,y,z), rs=rr(), ra=Vector3.new()})
		end
		srot, sang = rr(), Vector3.new()
		spin = true
	end

	local function toggleTrail() trail = not trail end

	-- HOME TAB BUTTONS
	HomeTab:CreateButton({ Name = "CUBE", Callback = makeCube })
	HomeTab:CreateButton({ Name = "RINGS", Callback = makeRing })
	HomeTab:CreateButton({ Name = "SPHERE", Callback = makeSphere })
	HomeTab:CreateButton({ Name = "TRAIL", Callback = toggleTrail })
	HomeTab:CreateButton({ Name = "REMOVE EVERYTHING", Callback = rc })

	-- UPDATE LOOP
	rs.Heartbeat:Connect(function(d)
		local c = p.Character
		if spin and c and c:FindFirstChild("HumanoidRootPart") then
			local r = c.HumanoidRootPart
			local ctr = r.Position + Vector3.new(0,10,0)
			if mode=="cube" then
				ang = ang + rot*d
				local rotcf = CFrame.Angles(ang.X, ang.Y, ang.Z)
				for _, x in ipairs(cube) do
					local cf = CFrame.new(ctr) * rotcf * CFrame.new(x.offset)
					ts:Create(x.part, ti, {CFrame=cf}):Play()
				end
			elseif mode=="ring" then
				ira, ora, ora2 = ira+irs*d, ora+ors*d, ora2+ors2*d
				for _, rg in ipairs({ir,or1,or2}) do
					for _, x in ipairs(rg) do
						x.angle = x.angle + d
						x.ra = x.ra + x.rs*d
						local pr = CFrame.Angles(x.ra.X, x.ra.Y, x.ra.Z)
						local rr2 = (rg==ir and CFrame.Angles(ira.X,ira.Y,ira.Z) or rg==or1 and CFrame.Angles(ora.X,ora.Y,ora.Z) or CFrame.Angles(ora2.X,ora2.Y,ora2.Z))
						local cf = CFrame.new(ctr-Vector3.new(0,10,0))*rr2*CFrame.new(math.cos(x.angle)*x.radius,0,math.sin(x.angle)*x.radius)*pr
						ts:Create(x.part, ti, {CFrame=cf}):Play()
					end
				end
			elseif mode=="sphere" then
				sang = sang + srot*d
				local srotcf = CFrame.Angles(sang.X, sang.Y, sang.Z)
				for _, x in ipairs(sphere) do
					x.ra = x.ra + x.rs*d
					local pr = CFrame.Angles(x.ra.X, x.ra.Y, x.ra.Z)
					local cf = CFrame.new(ctr-Vector3.new(0,10,0))*srotcf*CFrame.new(x.offset)*pr
					ts:Create(x.part, ti, {CFrame=cf}):Play()
				end
			end
		end
	end)

	-- ==============================
	-- PLAYER TAB
	-- ==============================
	local PlayerTab = Window:CreateTab("PLAYER", nil)
	PlayerTab:CreateSection("Character Settings")

	-- WalkSpeed / JumpPower / HipHeight
	local function getHum() return p.Character and p.Character:FindFirstChildOfClass("Humanoid") end

	PlayerTab:CreateSlider({ Name = "WalkSpeed", Range={16,200}, Increment=1, Suffix="WS", CurrentValue=16, Flag="WalkSpeedSlider", Callback=function(v) local h = getHum(); if h then h.WalkSpeed=v end end })
	PlayerTab:CreateSlider({ Name = "JumpPower", Range={50,300}, Increment=1, Suffix="JP", CurrentValue=50, Flag="JumpPowerSlider", Callback=function(v) local h = getHum(); if h then h.JumpPower=v end end })
	PlayerTab:CreateSlider({ Name = "HipHeight", Range={0,20}, Increment=0.5, Suffix="HH", CurrentValue=2, Flag="HipHeightSlider", Callback=function(v) local h = getHum(); if h then h.HipHeight=v end end })
	PlayerTab:CreateSlider({ Name = "Gravity", Range={0,400}, Increment=10, Suffix="G", CurrentValue=196, Flag="GravitySlider", Callback=function(v) workspace.Gravity=v end })
	PlayerTab:CreateSlider({ Name = "FOV", Range={30,120}, Increment=1, Suffix="FOV", CurrentValue=70, Flag="FOVSlider", Callback=function(v) workspace.CurrentCamera.FieldOfView=v end })

	-- Noclip
	local noclipConn
	PlayerTab:CreateToggle({ Name = "Noclip", CurrentValue=false, Flag="NoclipToggle", Callback=function(v)
		if v then
			noclipConn = rs.Stepped:Connect(function()
				local char = p.Character
				if char then
					for _,v in pairs(char:GetDescendants()) do if v:IsA("BasePart") then v.CanCollide=false end end
				end
			end)
		else
			if noclipConn then noclipConn:Disconnect(); noclipConn=nil end
		end
	end})

	-- Fly
	local flyConn
	PlayerTab:CreateToggle({ Name="Fly", CurrentValue=false, Flag="FlyToggle", Callback=function(v)
		if v then
			local char = p.Character or p.CharacterAdded:Wait()
			local hum = char:FindFirstChildOfClass("Humanoid")
			local hrp = char:FindFirstChild("HumanoidRootPart")
			flyConn = rs.RenderStepped:Connect(function()
				if hrp and hum then
					local dir = Vector3.zero
					if uis:IsKeyDown(Enum.KeyCode.W) then dir+=workspace.CurrentCamera.CFrame.LookVector end
					if uis:IsKeyDown(Enum.KeyCode.S) then dir-=workspace.CurrentCamera.CFrame.LookVector end
					if uis:IsKeyDown(Enum.KeyCode.A) then dir-=workspace.CurrentCamera.CFrame.RightVector end
					if uis:IsKeyDown(Enum.KeyCode.D) then dir+=workspace.CurrentCamera.CFrame.RightVector end
					if uis:IsKeyDown(Enum.KeyCode.Space) then dir+=Vector3.new(0,1,0) end
					if uis:IsKeyDown(Enum.KeyCode.LeftControl) then dir-=Vector3.new(0,1,0) end
					hrp.Velocity=dir*60
					hum.PlatformStand=true
				end
			end)
		else
			if flyConn then flyConn:Disconnect(); flyConn=nil end
			local hum = getHum()
			if hum then hum.PlatformStand=false end
		end
	end})

	-- Respawn
	PlayerTab:CreateButton({ Name="Respawn", Callback=function() if getHum() then getHum().Health=0 end end })

	-- Infinite Jump
	local infJump=false
	PlayerTab:CreateToggle({ Name="Infinite Jump", CurrentValue=false, Flag="InfJump", Callback=function(v) infJump=v end })
	uis.JumpRequest:Connect(function() if infJump and getHum() then getHum():ChangeState(Enum.HumanoidStateType.Jumping) end end)

	-- Teleport to Mouse
	PlayerTab:CreateKeybind({ Name="Teleport to Mouse", CurrentKeybind="T", HoldToInteract=false, Flag="TPMouse", Callback=function()
		if p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			local m = p:GetMouse()
			p.Character.HumanoidRootPart.CFrame = CFrame.new(m.Hit.Position+Vector3.new(0,3,0))
		end
	end})

	-- ==============================
	-- PLAYER HIGHLIGHTS
	-- ==============================
	local hlOn=false
	PlayerTab:CreateToggle({ Name="Highlight Players", CurrentValue=false, Flag="HLPlayers", Callback=function(v)
		hlOn=v
		if not v then
			for _,plr in ipairs(game.Players:GetPlayers()) do
				if plr.Character then
					local h=plr.Character:FindFirstChild("RazarHighlight")
					if h then h:Destroy() end
				end
			end
		end
	end})

	rs.Heartbeat:Connect(function()
		if hlOn then
			for _,plr in ipairs(game.Players:GetPlayers()) do
				if plr~=p then
					local c=plr.Character
					if c and c:FindFirstChild("HumanoidRootPart") then
						if not c:FindFirstChild("RazarHighlight") then
							local hl=Instance.new("Highlight")
							hl.Name="RazarHighlight"
							hl.FillTransparency=0.5
							hl.OutlineColor=Color3.fromRGB(255,255,0)
							hl.Parent=c
						end
					end
				end
			end
		end
	end)

	local tpDropdown
	local selected = nil

	local function refreshDropdown()
		local opts = {}
		for _,plr in ipairs(game.Players:GetPlayers()) do
			if plr ~= p then
				table.insert(opts, plr.Name)
			end
		end
		if tpDropdown then
			tpDropdown:Refresh(opts)
		end
	end

	tpDropdown = PlayerTab:CreateDropdown({
		Name = "Select Player",
		Options = {},
		CurrentOption = {},
		MultipleOptions = false,
		Flag = "TPToPlayerDropdown",
		Callback = function(opt)
			if #opt > 0 then
				selected = opt[1]
			end
		end,
	})

	PlayerTab:CreateButton({
		Name = "Teleport to Selected Player",
		Callback = function()
			if selected then
				local target = game.Players:FindFirstChild(selected)
				if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
					p.Character.HumanoidRootPart.CFrame = target.Character.HumanoidRootPart.CFrame + Vector3.new(0,3,0)
				end
			end
		end,
	})

	refreshDropdown()
	game.Players.PlayerAdded:Connect(refreshDropdown)
	game.Players.PlayerRemoving:Connect(refreshDropdown)

	local freecam = false
	local camSpeed = 2
	local camPart, moveConn, mouseConn, keys = nil, nil, nil, {W=false,A=false,S=false,D=false,Space=false,LeftShift=false}
	local cam = workspace.CurrentCamera
	local uis = game:GetService("UserInputService")
	local rs = game:GetService("RunService")
	local player = game.Players.LocalPlayer
	local rotationX = 0 -- pitch
	local rotationY = 0 -- yaw

	local function startFreecam()
		if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
		local hrp = player.Character.HumanoidRootPart

		camPart = Instance.new("Part")
		camPart.Size = Vector3.new(1,1,1)
		camPart.Anchored = true
		camPart.CanCollide = false
		camPart.Transparency = 1
		camPart.Position = hrp.Position
		camPart.Parent = workspace

		cam.CameraType = Enum.CameraType.Scriptable
		cam.CameraSubject = camPart

		uis.MouseBehavior = Enum.MouseBehavior.LockCenter

		moveConn = rs.RenderStepped:Connect(function(dt)
			local dir = Vector3.new()
			if keys.W then dir += camPart.CFrame.LookVector end
			if keys.S then dir -= camPart.CFrame.LookVector end
			if keys.A then dir -= camPart.CFrame.RightVector end
			if keys.D then dir += camPart.CFrame.RightVector end
			if keys.Space then dir += Vector3.new(0,1,0) end
			if keys.LeftShift then dir -= Vector3.new(0,1,0) end
			camPart.CFrame = camPart.CFrame + dir * camSpeed
			cam.CFrame = camPart.CFrame * CFrame.Angles(rotationX, rotationY, 0) -- lock roll
		end)

		uis.InputBegan:Connect(function(input, processed)
			if processed then return end
			if keys[input.KeyCode.Name] ~= nil then keys[input.KeyCode.Name] = true end
		end)

		uis.InputEnded:Connect(function(input)
			if keys[input.KeyCode.Name] ~= nil then keys[input.KeyCode.Name] = false end
		end)

		mouseConn = uis.InputChanged:Connect(function(input)
			if input.UserInputType == Enum.UserInputType.MouseMovement then
				rotationX = math.clamp(rotationX - input.Delta.Y/200, -math.pi/2, math.pi/2)
				rotationY = rotationY - input.Delta.X/200
			end
		end)
	end

	local function stopFreecam()
		if camPart then camPart:Destroy(); camPart=nil end
		cam.CameraType = Enum.CameraType.Custom
		if player.Character and player.Character:FindFirstChild("Humanoid") then
			cam.CameraSubject = player.Character.Humanoid
		end
		if moveConn then moveConn:Disconnect(); moveConn=nil end
		if mouseConn then mouseConn:Disconnect(); mouseConn=nil end
		keys = {W=false,A=false,S=false,D=false,Space=false,LeftShift=false}
		rotationX = 0
		rotationY = 0
		uis.MouseBehavior = Enum.MouseBehavior.Default
	end

	PlayerTab:CreateToggle({
		Name = "Freecam",
		CurrentValue = false,
		Flag = "FreecamToggle",
		Callback = function(v)
			freecam = v
			if freecam then
				startFreecam()
			else
				stopFreecam()
			end
		end,
	})
